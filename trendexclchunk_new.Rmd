---
title: "Primary HIV drug resistance in South Africa"
output:
  html_document: default
  pdf_document: default
---

####### This analysis on pre-ART resistance excluded patients with any prior exposure to ART, e.g. **for PMTCT**

The analysis involves **studies on HIV primary resistance** in South Africa, between 2000 and 2015.

We assessed trends in drug resistance in patients sampled from different populations and studies, using a generalized linear mixed effects regression (glmer) model [http://www.ats.ucla.edu/stat/r/dae/melogit.htm]().

#######################################################################################################################    
**Library**
```{r library, echo=TRUE}
    library(lme4)
```

```{r lme}
    model_summary <- function(m){
        lor<-summary(m)$coefficients[,1]
        se<-summary(m)$coefficients[,2]
        or <-exp(lor)
        or1 <- exp(lor - 1.96*se)
        or2 <- exp(lor + 1.96*se)
        vars <- rownames(summary(m)$coefficients)
        num_vars <- length(vars)
        cat("\n##OR\n")
        for (i in 1:num_vars){
        or_var <- round(or[i],3)
        or1_var <- round(or1[i],3)
        or2_var <- round(or2[i],3)
        ci <- paste("(",or1_var, "-", or2_var,")", sep="")
        p_var <- round(coef(summary(m)) [i,4],6)
        if(p_var < 0.05) { p_var = paste(p_var, "*", sep="")}
        cat(paste(vars[i], or_var, ci, p_var, sep="\t"), "\n")
        }
    }
```
**Data input**  
```{r}
    trendexcl <- read.table("~/Documents/Manuscripts/2017/3_PDR_trends_Manuscript_3/Re-Analysis/Database/trendexcl.txt", sep="\t", na.strings=c('NULL'), header=T)

    trendexcl$NumPISDRMs <- as.integer(as.character(trendexcl$NumPISDRMs))
    trendexcl$NumNRTISDRMs <- as.integer(as.character(trendexcl$NumNRTISDRMs))
    trendexcl$NumNNRTISDRMs <- as.integer(as.character(trendexcl$NumNNRTISDRMs))
```

```{r echo=FALSE}
    trendexcl$NumSDRMs <- trendexcl$NumNRTISDRMs + trendexcl$NumNNRTISDRMs  
    
    trendexcl[! is.na(trendexcl$NumPISDRMs), c("NumSDRMs")] <- trendexcl[!is.na(trendexcl$NumPISDRMs), c("NumSDRMs")] + trendexcl[! is.na(trendexcl$NumPISDRMs), c("NumPISDRMs")] 

    trendexcl$NumSDRMs <- rowSums(trendexcl[,c("NumPISDRMs", "NumNRTISDRMs", "NumNNRTISDRMs")], na.rm=TRUE)  
```

###########################################################################################
```{r echo=FALSE}
    trendexcl$Mutant<- 0
    trendexcl[trendexcl$NumSDRMs > 0, c("Mutant")] <- 1
    trendexcl$Mutant <- as.factor(trendexcl$Mutant)
```

```{r echo=FALSE}
    trendexcl$NRTIMutant<- 0
    trendexcl[! is.na(trendexcl$NumNRTISDRMs) & trendexcl$NumNRTISDRMs > 0, c("NRTIMutant")] <- 1
    trendexcl[is.na(trendexcl$NumNRTISDRMs), c("NRTIMutant")] <- NA
    trendexcl$NRTIMutant <- as.factor(trendexcl$NRTIMutant)
    
    trendexcl$NNRTIMutant<- 0
    trendexcl[! is.na(trendexcl$NumNNRTISDRMs) & trendexcl$NumNNRTISDRMs > 0, c("NNRTIMutant")] <- 1
    trendexcl[is.na(trendexcl$NumNNRTISDRMs), c("NNRTIMutant")] <- NA
    trendexcl$NNRTIMutant <- as.factor(trendexcl$NNRTIMutant)
    
    trendexcl$PIMutant<- 0
    trendexcl[! is.na(trendexcl$NumPISDRMs) & trendexcl$NumPISDRMs > 0, c("PIMutant")] <- 1
    trendexcl[is.na(trendexcl$NumPISDRMs), c("PIMutant")] <- NA
    trendexcl$PIMutant <- as.factor(trendexcl$PIMutant)
```

```{r echo=FALSE}
studies <- unique(trendexcl$StudyID)

    for (StudyID in studies){
       d<- trendexcl[trendexcl$StudyID == StudyID, ]
    }
```

```{r echo=FALSE}
    trendexcl$IsolateYear2 <- trendexcl$IsolateYear - min (trendexcl$IsolateYear)
```

**Generalized linear mixed effects regression (glmer)**

```{r Overall, echo=FALSE}
    m1 <- glmer(Mutant ~ IsolateYear2 + (1|StudyID), data=trendexcl, family=binomial)
    print(summary(m1))
    model_summary(m1)
```
**NRTI**
```{r echo=FALSE}
    m2 <- glmer(NRTIMutant ~ IsolateYear2 + (1|StudyID), data=trendexcl, family=binomial)
    print(summary(m2))
    model_summary(m2)
```
**NNRTI**
```{r NNRTI}
    m2 <- glmer(NNRTIMutant ~ IsolateYear2 + (1|StudyID), data=trendexcl, family=binomial)
    print(summary(m2))
    model_summary(m2)
```
**PI**
```{r PI}
    m2 <- glmer(PIMutant ~ IsolateYear2 + (1|StudyID), data=trendexcl, family=binomial)
    print(summary(m2))
    model_summary(m2)
```
**Number resistant by year**
```{r echo=FALSE}
    mytable <- table(trendexcl$IsolateYear, trendexcl$Mutant)
    print(mytable)
```
**Percentage resistance by year**
```{r echo=FALSE}
    prop.table(mytable, 1) * 100

    b <- as.data.frame(prop.table(mytable, 1) * 100)

    c <- b[-c(1:15), ]
    names(c) [1] <- 'IsolateYear'
    c$Percentage <- c$Freq
    c$Freq <- NULL
    c$Var2 <- NULL

    i <- d[c("IsolateYear", "Mutant", "NRTIMutant", "NNRTIMutant", "PIMutant")]
```
**Drug class resistance by year**

NRTI
```{r echo=FALSE}
    mytable1 <- table(trendexcl$IsolateYear, trendexcl$NRTIMutant) 
    prop.table(mytable1, 1) * 100
    j <- as.data.frame(prop.table(mytable1, 1) * 100)

    k <- j[-c(1:15), ]
    names(k) [1] <- 'IsolateYear'
    k$NRTI_Percentage <- k$Freq
    k$Freq <- NULL
    k$Var2 <- NULL
```
NNRTI
```{r echo=FALSE}

    mytable2 <- table(trendexcl$IsolateYear, trendexcl$NNRTIMutant) 
    prop.table(mytable2, 1) * 100
    l <- as.data.frame(prop.table(mytable2, 1) * 100)

    m <- l[-c(1:15), ]
    names(m) [1] <- 'IsolateYear'
    m$NNRTI_Percentage <- m$Freq
    m$Freq <- NULL
    m$Var2 <- NULL
```
PI
```{r echo=FALSE}

    mytable3 <- table(trendexcl$IsolateYear, trendexcl$PIMutant) 
    prop.table(mytable3, 1) * 100
    n <- as.data.frame(prop.table(mytable3, 1) * 100)

    o <- n[-c(1:15), ]
    names(o) [1] <- 'IsolateYear'
    o$PI_Percentage <- o$Freq
    o$Freq <- NULL
    o$Var2 <- NULL
```
**Overall percentage resistance**
```{r echo=FALSE}
    e <- mytable
    f <- sum(e[,2])
    g <- sum(e[,1]) + sum(e[,2])
    totres <- f/g * 100
    print(totres)
```

```{r echo=FALSE}

    NumRTseqs <- c("37", "120", "149",  "343", "100",  "303", "708",  "781", "163",  "72", "381",
    "253", "370",  "1257", "498")
    NumPRseqs <- c( "0", "125",  "131", "0",  "29", "291",  "686", "728",  "160", "72",  "379",
    "249",  "370", "1257",  "498")
    
    Numstu <- c("1", "3", "2", "2", "2", "2", "4", "7", "4", "1", "1", "1", "2", "3", "1")
    Numseqs<- c("37", "161", "198", "343", "100", "303", "708", "792", "164", "72", "381", "253", "370", "1257", "498")
```

```{r echo=FALSE}
    a <- data.frame(c, Numstu, Numseqs, NumRTseqs, NumPRseqs)
    df <- data.frame(a, k, m, o)
    df$IsolateYear.1 <- NULL
    df$IsolateYear.2 <- NULL
    df$IsolateYear.3 <- NULL
```

```{r echo=FALSE}
    df$IsolateYear <- as.numeric(as.character(df$IsolateYear))
    df$Numseqs <- as.numeric(as.character(df$Numseqs))
```
**Trends**
```{r echo=FALSE}

    library(ggplot2)
    df$Numstu.seqs <- paste(df$Numstu, df$Numseqs, sep="\n")
    
    b4 <- ggplot(df, aes(x=IsolateYear, y=Percentage, width=0.99)) + ggtitle("Overall trend in drug resistance") + theme(plot.title = element_text(hjust = 0.5)) + theme(plot.title = element_text(size=20, face="bold")) + geom_bar(stat="identity", color="black", fill="white") + geom_text(aes(label=Numstu.seqs), vjust=1.05, color="black", size=1.8) + geom_hline(yintercept=5, linetype="dashed", color = "blue") + geom_hline(yintercept=15, linetype="dashed", color = "red") + theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 11)) + theme(axis.text.y = element_text(angle = 0, hjust = 1, size = 11)) + scale_x_continuous(breaks=seq(2000, 2015)) + theme(axis.title=element_text(size=15))
    plot(b4)
```

```{r echo=FALSE}
    b1 <- ggplot(df, aes(x=IsolateYear, y=NRTI_Percentage, width=0.99)) + ggtitle("NRTI resistance") + theme(plot.title = element_text(hjust = 0.5)) + geom_bar(stat="identity", color="black", fill="white") + geom_hline(yintercept=5, linetype="dashed", color = "blue") + geom_hline(yintercept=15, linetype="dashed", color = "red") + ylim(0, 15.5) + theme(plot.title = element_text(size=20, face="bold")) + theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 15)) + theme(axis.text.y = element_text(angle = 0, hjust = 1, size = 15)) + theme(axis.title=element_text(size=15))
    plot(b1)
```

```{r echo=FALSE}
    b2 <- ggplot(df, aes(x=IsolateYear, y=NNRTI_Percentage, width=0.99)) + ggtitle("NNRTI resistance") + theme(plot.title = element_text(hjust = 0.5)) + geom_bar(stat="identity", color="black", fill="white") + geom_hline(yintercept=5, linetype="dashed", color = "blue") + geom_hline(yintercept=15, linetype="dashed", color = "red") + ylim(0, 15.5) + theme(plot.title = element_text(size=20, face="bold")) + theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 15)) + theme(axis.text.y = element_text(angle = 0, hjust = 1, size = 15)) + theme(axis.title=element_text(size=15))
    plot(b2)
```

```{r echo=FALSE}
    b3 <- ggplot(df, aes(x=IsolateYear, y=PI_Percentage, width=0.99)) + ggtitle("PI resistance") + theme(plot.title = element_text(hjust = 0.5)) + geom_bar(stat="identity", color="black", fill="white") + geom_hline(yintercept=5, linetype="dashed", color = "blue", na.rm=TRUE) + geom_hline(yintercept=15, linetype="dashed", color = "red", na.rm=TRUE) + ylim(0, 15) + theme(plot.title = element_text(size=20, face="bold")) + theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 15)) + theme(axis.text.y = element_text(angle = 0, hjust = 1, size = 15)) + theme(axis.title=element_text(size=15))
    plot(b3)
```

**Combined plots**

```{r echo=FALSE}
    library(gridExtra)
    b6 <- grid.arrange(arrangeGrob(b2, b1, b3), ncol = 1)
```

**Bubble chart**

```{r echo=FALSE}

    sp <- ggplot(data=df, aes(x=IsolateYear, y = Percentage, group = 1)) + geom_point(aes(size = Numseqs), color = "purple") + scale_size(range = c(2,12)) 
    
    sp + geom_hline(yintercept=5, linetype="dashed", color = "blue") + geom_hline(yintercept=15, linetype="dashed", color = "red") + theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13)) + theme(axis.text.y = element_text(angle = 0, hjust = 0.5, size = 13)) + ggtitle("Overall trend in drug resistance") + theme(plot.title = element_text(hjust = 0.5)) + theme(plot.title = element_text(size=20, face="bold")) + theme(axis.title=element_text(size=15))
```

```{r echo=FALSE}

    df$NumRTseqs <- as.numeric(as.character(df$NumRTseqs))
    df$NumPRseqs <- as.numeric(as.character(df$NumPRseqs))

```

**NRTI**

```{r echo=FALSE}

    plot(NRTI_Percentage ~ IsolateYear, data = df, type = "l")
    
    p <- ggplot(data=df, aes(x=IsolateYear, y = NRTI_Percentage, group = 1)) + geom_point(aes(size = NumRTseqs), color = "purple") + scale_size(range = c(2,12)) 
    
    p + geom_hline(yintercept=5, linetype="dashed", color = "blue") + geom_hline(yintercept=15, linetype="dashed", color = "red") + theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + ggtitle("NRTI drug resistance") + theme(plot.title = element_text(hjust = 0.5)) + theme(plot.title = element_text(size=20, face="bold")) + theme(axis.title=element_text(size=15)) + theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13)) + theme(axis.text.y = element_text(angle = 0, hjust = 0.5, size = 13))
    
```

**NNRTI**

```{r echo=FALSE}

    plot(NNRTI_Percentage ~ IsolateYear, data = df)
    
    p <- ggplot(data=df, aes(x=IsolateYear, y = NNRTI_Percentage, group = 1)) + geom_point(aes(size = NumRTseqs), color = "purple") + scale_size(range = c(2,12)) 
    
    p + geom_hline(yintercept=5, linetype="dashed", color = "blue") + geom_hline(yintercept=15, linetype="dashed", color = "red") + theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + ggtitle("NNRTI drug resistance") + theme(plot.title = element_text(hjust = 0.5)) + theme(plot.title = element_text(size=20, face="bold"))  + theme(axis.title=element_text(size=15)) + theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13)) + theme(axis.text.y = element_text(angle = 0, hjust = 0.5, size = 13))
    
```

**PI**

```{r echo=FALSE}

     plot(PI_Percentage ~ IsolateYear, data = df)
    
    r <- ggplot(data=df, aes(x=IsolateYear, y = PI_Percentage, group = 1)) + geom_point(aes(size = NumPRseqs), color = "purple") + scale_size(range = c(2,12)) 
    
    r + geom_hline(yintercept=5, linetype="dashed", color = "blue") + geom_hline(yintercept=15, linetype="dashed", color = "red") + theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + ggtitle("PI drug resistance") + theme(plot.title = element_text(hjust = 0.5)) + theme(plot.title = element_text(size=20, face="bold"))  + theme(axis.title=element_text(size=15)) + theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13)) + theme(axis.text.y = element_text(angle = 0, hjust = 0.5, size = 13))

```
